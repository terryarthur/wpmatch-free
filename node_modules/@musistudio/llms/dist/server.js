"use strict";var de=Object.create;var ee=Object.defineProperty;var pe=Object.getOwnPropertyDescriptor;var fe=Object.getOwnPropertyNames;var ue=Object.getPrototypeOf,me=Object.prototype.hasOwnProperty;var he=(o,e,t,n)=>{if(e&&typeof e=="object"||typeof e=="function")for(let s of fe(e))!me.call(o,s)&&s!==t&&ee(o,s,{get:()=>e[s],enumerable:!(n=pe(e,s))||n.enumerable});return o};var B=(o,e,t)=>(t=o!=null?de(ue(o)):{},he(e||!o||!o.__esModule?ee(t,"default",{value:o,enumerable:!0}):t,o));var ae=B(require("fastify")),le=B(require("@fastify/cors"));var F=require("fs"),G=require("path"),te=require("dotenv"),K=class{config={};options;constructor(e={jsonPath:"./config.json"}){this.options={envPath:e.envPath||".env",jsonPath:e.jsonPath,useEnvFile:e.useEnvFile!==!1,useJsonFile:e.useJsonFile!==!1,useEnvironmentVariables:e.useEnvironmentVariables!==!1,...e},this.loadConfig()}loadConfig(){this.options.useEnvFile&&this.loadEnvConfig(),this.options.useJsonFile&&this.options.jsonPath&&this.loadJsonConfig(),this.options.useEnvironmentVariables&&this.loadEnvironmentVariables()}loadJsonConfig(){if(!this.options.jsonPath)return;let e=this.isAbsolutePath(this.options.jsonPath)?this.options.jsonPath:(0,G.join)(process.cwd(),this.options.jsonPath);if((0,F.existsSync)(e))try{let t=(0,F.readFileSync)(e,"utf-8"),n=JSON.parse(t);this.config={...this.config,...n},console.log(`Loaded JSON config from: ${e}`)}catch(t){console.warn(`Failed to load JSON config from ${e}:`,t)}else console.warn(`JSON config file not found: ${e}`)}loadEnvConfig(){let e=this.isAbsolutePath(this.options.envPath)?this.options.envPath:(0,G.join)(process.cwd(),this.options.envPath);if((0,F.existsSync)(e))try{let t=(0,te.config)({path:e});t.parsed&&(this.config={...this.config,...this.parseEnvConfig(t.parsed)})}catch(t){console.warn(`Failed to load .env config from ${e}:`,t)}else console.warn(`.env file not found: ${e}`)}loadEnvironmentVariables(){let e=this.parseEnvConfig(process.env);this.config={...this.config,...e}}parseEnvConfig(e){let t={};return Object.assign(t,e),t}isAbsolutePath(e){return e.startsWith("/")||e.includes(":")}get(e,t){let n=this.config[e];return n!==void 0?n:t}getAll(){return{...this.config}}getHttpsProxy(){return this.get("HTTPS_PROXY")||this.get("https_proxy")||this.get("httpsProxy")}has(e){return this.config[e]!==void 0}set(e,t){this.config[e]=t}reload(){this.config={},this.loadConfig()}getConfigSummary(){let e=[];return this.options.useJsonFile&&this.options.jsonPath&&e.push(`JSON: ${this.options.jsonPath}`),this.options.useEnvFile&&e.push(`ENV: ${this.options.envPath}`),this.options.useEnvironmentVariables&&e.push("Environment Variables"),`Config sources: ${e.join(", ")}`}},P=new K;var ne=B(require("node:fs")),ge="app.log";function u(...o){if(console.log(...o),!!0)return;let n=`[${new Date().toISOString()}] ${Array.isArray(o)?o.map(s=>typeof s=="object"?JSON.stringify(s):String(s)).join(" "):""}
`;ne.default.appendFileSync(ge,n,"utf8")}function $(o,e=500,t="internal_error",n="api_error"){let s=new Error(o);return s.statusCode=e,s.code=t,s.type=n,s}async function oe(o,e,t){e.log.error(o);let n=o.statusCode||500,s={error:{message:o.message||"Internal Server Error",type:o.type||"api_error",code:o.code||"internal_error"}};return t.code(n).send(s)}var N=class{providers=new Map;modelRoutes=new Map;constructor(){this.initializeCustomProviders()}initializeCustomProviders(){let e=P.get("providers");if(e&&Array.isArray(e)){this.initializeFromProvidersArray(e);return}}initializeFromProvidersArray(e){e.forEach(t=>{try{if(!t.name||!t.api_base_url||!t.api_key)return;this.registerProvider({name:t.name,baseUrl:t.api_base_url,apiKey:t.api_key,models:t.models||[`${t.id}-default`],transformer:t.transformer||{}}),u(`${t.name} provider registered`)}catch(n){u(`${t.name} provider registered error: ${n}`)}})}registerProvider(e){let t={...e};return this.providers.set(t.name,t),e.models.forEach(n=>{let s=`${t.name},${n}`,a={provider:t.name,model:n,fullModel:s};this.modelRoutes.set(s,a),this.modelRoutes.has(n)||this.modelRoutes.set(n,a)}),t}getProviders(){return Array.from(this.providers.values())}getProvider(e){return this.providers.get(e)}updateProvider(e,t){let n=this.providers.get(e);if(!n)return null;let s={...n,...t,updatedAt:new Date};return this.providers.set(e,s),t.models&&(n.models.forEach(a=>{let r=`${n.id},${a}`;this.modelRoutes.delete(r),this.modelRoutes.delete(a)}),t.models.forEach(a=>{let r=`${n.id},${a}`,l={providerId:n.id,model:a,fullModel:r};this.modelRoutes.set(r,l),this.modelRoutes.has(a)||this.modelRoutes.set(a,l)})),u(`\u2705 \u66F4\u65B0\u670D\u52A1\u5546 ${s.name} (${e})`),s}deleteProvider(e){let t=this.providers.get(e);return t?(t.models.forEach(n=>{let s=`${t.id},${n}`;this.modelRoutes.delete(s),this.modelRoutes.delete(n)}),this.providers.delete(e),u(`\u2705 \u5220\u9664\u670D\u52A1\u5546 ${t.name} (${e})`),!0):!1}toggleProvider(e,t){let n=this.providers.get(e);return n?(n.enabled=t,n.updatedAt=new Date,u(`\u2705 ${t?"\u542F\u7528":"\u7981\u7528"}\u670D\u52A1\u5546 ${n.name} (${e})`),!0):!1}resolveModelRoute(e){let t=this.modelRoutes.get(e);if(!t)return null;let n=this.providers.get(t.providerId);return!n||!n.enabled?null:{provider:n,originalModel:e,targetModel:t.model}}getAvailableModelNames(){let e=[];return this.providers.forEach(t=>{t.enabled&&t.models.forEach(n=>{e.push(n),e.push(`${t.id},${n}`)})}),e}getModelRoutes(){return Array.from(this.modelRoutes.values())}async getAvailableModels(){let e=[];return this.providers.forEach(t=>{t.enabled&&t.models.forEach(n=>{e.push({id:n,object:"model",created:Math.floor(t.createdAt.getTime()/1e3),owned_by:t.name,provider:t.name}),e.push({id:`${t.id},${n}`,object:"model",created:Math.floor(t.createdAt.getTime()/1e3),owned_by:t.name,provider:t.id})})}),{object:"list",data:e}}};function ye(o){return o.map(e=>({type:"function",function:{name:e.function.name,description:e.function.description,parameters:e.function.parameters}}))}function _e(o){return o.map(e=>({name:e.function.name,description:e.function.description,input_schema:e.function.parameters}))}function ve(o){return o.map(e=>({type:"function",function:{name:e.function.name,description:e.function.description||"",parameters:e.function.parameters}}))}function be(o){return o.map(e=>({type:"function",function:{name:e.name,description:e.description||"",parameters:e.input_schema}}))}function Ce(o){let e=[],t=new Map;o.messages.forEach(s=>{s.role==="tool"&&s.tool_call_id&&(t.has(s.tool_call_id)||t.set(s.tool_call_id,[]),t.get(s.tool_call_id).push({role:"tool",content:s.content,tool_call_id:s.tool_call_id}))});for(let s=0;s<o.messages.length;s++){let a=o.messages[s];if(a.role==="tool")continue;let r={role:a.role,content:a.content};if(a.tool_calls&&a.tool_calls.length>0&&(r.tool_calls=a.tool_calls,r.content===null&&(r.content=null)),e.push(r),a.role==="assistant"&&a.tool_calls&&a.tool_calls.length>0)for(let l of a.tool_calls)t.has(l.id)?(t.get(l.id).forEach(c=>{e.push(c)}),t.delete(l.id)):e.push({role:"tool",content:JSON.stringify({success:!0,message:"Tool call executed successfully",tool_call_id:l.id}),tool_call_id:l.id})}if(t.size>0)for(let[s,a]of t.entries())a.forEach(r=>{e.push(r)});let n={messages:e,model:o.model,max_tokens:o.max_tokens,temperature:o.temperature,stream:o.stream};return o.tools&&o.tools.length>0&&(n.tools=ye(o.tools),o.tool_choice&&(o.tool_choice==="auto"||o.tool_choice==="none"?n.tool_choice=o.tool_choice:n.tool_choice={type:"function",function:{name:o.tool_choice}})),n}function Re(o){let e=o.messages.filter(c=>c.role==="system"),t=o.messages.filter(c=>c.role!=="system"),n=e.length>0?e.map(c=>c.content).join(`
`):void 0,s=[];for(let c=0;c<t.length;c++){let h=t[c];if(h.role==="tool")continue;let d={role:h.role};if(h.tool_calls&&h.tool_calls.length>0){u("\u{1F527} \u8F6C\u6362tool_calls\u4E3AAnthropic\u683C\u5F0F");let m=[];h.content&&h.content!==null&&h.content!=="null"&&h.content.trim()&&m.push({type:"text",text:h.content}),h.tool_calls.forEach(p=>{m.push({type:"tool_use",id:p.id,name:p.function.name,input:JSON.parse(p.function.arguments||"{}")})}),d.content=m}else if(h.role==="user"){let m=[],p=c-1,g=[];for(;p>=0&&t[p].role==="tool";)g.unshift(t[p]),p--;g.forEach(f=>{m.push({type:"tool_result",tool_use_id:f.tool_call_id,content:f.content||""})}),h.content&&h.content.trim()&&m.push({type:"text",text:h.content}),m.length===1&&m[0].type==="text"?d.content=m[0].text:m.length===0?d.content="":d.content=m}else d.content=h.content||"";s.push(d)}let a=t.length-1,r=!1,l=[];for(let c=a;c>=0&&t[c].role==="tool";c--)l.unshift(t[c]),r=!0;if(r){u("\u{1F527} \u53D1\u73B0\u672A\u5904\u7406\u7684\u5DE5\u5177\u54CD\u5E94\uFF0C\u521B\u5EFA\u865A\u62DF\u7528\u6237\u6D88\u606F");let c=[];l.forEach(h=>{c.push({type:"tool_result",tool_use_id:h.tool_call_id,content:h.content||""})}),s.push({role:"user",content:c})}let i={messages:s,model:o.model,max_tokens:o.max_tokens||1024,temperature:o.temperature,stream:o.stream,system:n};return o.tools&&o.tools.length>0&&(i.tools=_e(o.tools),o.tool_choice&&(o.tool_choice==="auto"?i.tool_choice={type:"auto"}:o.tool_choice==="none"?delete i.tools:i.tool_choice={type:"tool",name:o.tool_choice})),i}function ke(o){try{let e=JSON.parse(o);return Array.isArray(e)&&e.some(t=>t.type==="tool_use"&&t.id&&t.name)}catch{return!1}}function xe(o){let t={messages:o.messages.map(n=>{if(n.role==="assistant"&&typeof n.content=="string"&&ke(n.content))try{let a=JSON.parse(n.content).map(r=>({id:r.id,type:"function",function:{name:r.name,arguments:JSON.stringify(r.input||{})}}));return{role:n.role,content:null,tool_calls:a}}catch{return{role:n.role,content:n.content}}return n.role==="tool"?{role:n.role,content:typeof n.content=="string"?n.content:JSON.stringify(n.content),tool_call_id:n.tool_call_id}:{role:n.role,content:typeof n.content=="string"?n.content:JSON.stringify(n.content),...n.tool_calls&&{tool_calls:n.tool_calls}}}),model:o.model,max_tokens:o.max_tokens,temperature:o.temperature,stream:o.stream};return o.tools&&o.tools.length>0&&(t.tools=ve(o.tools),o.tool_choice&&(typeof o.tool_choice=="string"?t.tool_choice=o.tool_choice:o.tool_choice.type==="function"&&(t.tool_choice=o.tool_choice.function.name))),t}function Se(o){let e=[];o.system&&e.push({role:"system",content:o.system});let t=[],n=[],s=null;for(let r=0;r<o.messages.length;r++){let l=o.messages[r];if(typeof l.content=="string"){if(s==="assistant"&&t.length>0&&l.role!=="assistant"){let i={role:"assistant",content:n.join("")||null,tool_calls:t.length>0?t:void 0};i.tool_calls&&n.length===0&&(i.content=null),e.push(i),t.length=0,n.length=0}e.push({role:l.role,content:l.content})}else if(Array.isArray(l.content)){let i=[],c=[],h=[];if(l.content.forEach(d=>{d.type==="text"?i.push(d.text):d.type==="tool_use"?c.push({id:d.id,type:"function",function:{name:d.name,arguments:JSON.stringify(d.input||{})}}):d.type==="tool_result"&&h.push(d)}),h.length>0){if(s==="assistant"&&t.length>0){let d={role:"assistant",content:n.join("")||null,tool_calls:t};n.length===0&&(d.content=null),e.push(d),t.length=0,n.length=0}h.forEach(d=>{e.push({role:"tool",content:typeof d.content=="string"?d.content:JSON.stringify(d.content),tool_call_id:d.tool_use_id})})}else if(l.role==="assistant")if(s==="assistant")t.push(...c),n.push(...i);else{if(t.length>0){let d={role:"assistant",content:n.join("")||null,tool_calls:t};n.length===0&&(d.content=null),e.push(d)}t.length=0,n.length=0,t.push(...c),n.push(...i)}else{if(s==="assistant"&&t.length>0){let m={role:"assistant",content:n.join("")||null,tool_calls:t};n.length===0&&(m.content=null),e.push(m),t.length=0,n.length=0}let d={role:l.role,content:i.join("")||null};c.length>0&&(d.tool_calls=c,i.length===0&&(d.content=null)),e.push(d)}}else{if(s==="assistant"&&t.length>0){let i={role:"assistant",content:n.join("")||null,tool_calls:t};n.length===0&&(i.content=null),e.push(i),t.length=0,n.length=0}e.push({role:l.role,content:JSON.stringify(l.content)})}s=l.role}if(s==="assistant"&&t.length>0){let r={role:"assistant",content:n.join("")||null,tool_calls:t};n.length===0&&(r.content=null),e.push(r)}let a={messages:e,model:o.model,max_tokens:o.max_tokens,temperature:o.temperature,stream:o.stream};return o.tools&&o.tools.length>0&&(a.tools=be(o.tools),o.tool_choice&&(o.tool_choice.type==="auto"?a.tool_choice="auto":o.tool_choice.type==="tool"&&(a.tool_choice=o.tool_choice.name))),a}function se(o,e){let t;return e.sourceProvider==="openai"?t=xe(o):e.sourceProvider==="anthropic"?t=Se(o):t=o,e.targetProvider==="openai"?Ce(t):Re(t)}var re=require("undici");function L(o,e,t){let n=new Headers({"Content-Type":"application/json"});t.headers&&Object.entries(t.headers).forEach(([i,c])=>{n.set(i,c)});let s,a=AbortSignal.timeout(t.TIMEOUT??60*1e3*60);if(t.signal){let i=new AbortController,c=()=>i.abort();t.signal.addEventListener("abort",c),a.addEventListener("abort",c),s=i.signal}else s=a;let r={method:"POST",headers:n,body:JSON.stringify(e),signal:s},l=P.getHttpsProxy();return l&&typeof global<"u"&&(r.dispatcher=new re.ProxyAgent(new URL(l).toString())),fetch(typeof o=="string"?o:o.toString(),r)}var D=class{providerService;constructor(){this.providerService=new N}registerProvider(e){return this.providerService.registerProvider(e)}getProviders(){return this.providerService.getProviders()}getProvider(e){return this.providerService.getProvider(e)}updateProvider(e,t){return this.providerService.updateProvider(e,t)}deleteProvider(e){return this.providerService.deleteProvider(e)}toggleProvider(e,t){return this.providerService.toggleProvider(e,t)}resolveRoute(e){let t=this.providerService.resolveModelRoute(e);if(!t)throw new Error(`Model ${e} not found. Available models: ${this.getAvailableModelNames().join(", ")}`);return t}async handleOpenAIFormatRequest(e,t){try{this.validateRequest(e);let n=e.model,s=this.resolveRoute(n),{provider:a,targetModel:r}=s,l=this.convertOpenAIToUnified(e);l.model=r;let i;if(a.type==="anthropic"?i=se(l,{sourceProvider:"openai",targetProvider:"anthropic"}):i=l,t?.aborted)throw new Error("Request was aborted");let c=await L(this.getProvider(a.id),i,{signal:t});if(t?.aborted)throw new Error("Request was aborted");let h=e.stream===!0;if(a.type==="anthropic")if(h){if(!c.body)throw new Error("Stream response body is null");let d=await this.convertAnthropicStreamToOpenAI(c.body);return new Response(d,{headers:{"Content-Type":"text/event-stream","Cache-Control":"no-cache",Connection:"keep-alive"}})}else{let d=await c.json(),m=this.convertAnthropicResponseToOpenAI(d);return new Response(JSON.stringify(m),{headers:{"Content-Type":"application/json"}})}else return c}catch(n){if(n instanceof Error&&(n.message.includes("aborted")||n.name==="AbortError"))throw n;if(e?.stream){let s=this.createOpenAIErrorStream(n);return new Response(s,{headers:{"Content-Type":"text/event-stream","Cache-Control":"no-cache",Connection:"keep-alive"}})}else throw n}}convertAnthropicResponseToOpenAI(e){let t=e.content.find(a=>a.type==="text"),s=e.content.filter(a=>a.type==="tool_use").map((a,r)=>({id:a.id||`call_${Date.now()}_${r}`,type:"function",function:{name:a.name,arguments:JSON.stringify(a.input||{})}}));return{id:`chatcmpl-${Date.now()}`,object:"chat.completion",created:Math.floor(Date.now()/1e3),model:e.model,choices:[{index:0,message:{role:"assistant",content:t?.text||null,refusal:null,tool_calls:s.length>0?s:void 0},logprobs:null,finish_reason:e.stop_reason==="end_turn"?"stop":e.stop_reason==="max_tokens"?"length":e.stop_reason==="tool_use"?"tool_calls":(e.stop_reason==="stop_sequence","stop")}],usage:{prompt_tokens:e.usage.input_tokens,completion_tokens:e.usage.output_tokens,total_tokens:e.usage.input_tokens+e.usage.output_tokens}}}async convertAnthropicStreamToOpenAI(e){return new ReadableStream({async start(n){let s=new TextEncoder,a="",r="unknown",l=new Map,i=!1,c=m=>{if(!i)try{n.enqueue(m)}catch(p){if(p instanceof TypeError&&p.message.includes("Controller is already closed"))u("\u26A0\uFE0F \u63A7\u5236\u5668\u5DF2\u5173\u95ED\uFF0C\u505C\u6B62\u53D1\u9001\u6570\u636E"),i=!0;else throw p}},h=()=>{if(!i)try{n.close(),i=!0}catch(m){if(m instanceof TypeError&&m.message.includes("Controller is already closed"))u("\u26A0\uFE0F \u63A7\u5236\u5668\u5DF2\u7ECF\u5173\u95ED"),i=!0;else throw m}},d=null;try{d=e.getReader();let m=new TextDecoder,p="";for(;;){if(i){u("\u26A0\uFE0F \u63A7\u5236\u5668\u5DF2\u5173\u95ED\uFF0C\u9000\u51FA\u6D41\u5904\u7406");break}let{done:g,value:f}=await d.read();if(g)break;p+=m.decode(f,{stream:!0});let x=p.split(`
`);p=x.pop()||"";for(let C of x){if(i)break;if(C.startsWith("data: ")){let y=C.slice(6);if(y==="[DONE]")continue;try{let R=JSON.parse(y),A=null;if(R.type==="message_start"&&!i)a=`chatcmpl-${Date.now()}`,r=R.message?.model||"unknown",A={id:a,object:"chat.completion.chunk",created:Math.floor(Date.now()/1e3),model:r,choices:[{index:0,delta:{role:"assistant",content:""},logprobs:null,finish_reason:null}]};else if(R.type==="content_block_start"&&!i){let _=R.content_block;if(_?.type==="tool_use"){let k=_.id||`call_${Date.now()}_${R.index}`,j={index:R.index,id:k,type:"function",function:{name:_.name,arguments:""}};l.set(R.index,j),A={id:a||`chatcmpl-${Date.now()}`,object:"chat.completion.chunk",created:Math.floor(Date.now()/1e3),model:r,choices:[{index:0,delta:{tool_calls:[j]},logprobs:null,finish_reason:null}]}}}else if(R.type==="content_block_delta"&&!i){let _=R.delta;if(_?.type==="text_delta"&&_.text)A={id:a||`chatcmpl-${Date.now()}`,object:"chat.completion.chunk",created:Math.floor(Date.now()/1e3),model:r,choices:[{index:0,delta:{content:_.text},logprobs:null,finish_reason:null}]};else if(_?.type==="input_json_delta"&&_.partial_json){let k=R.index;l.get(k)&&(A={id:a||`chatcmpl-${Date.now()}`,object:"chat.completion.chunk",created:Math.floor(Date.now()/1e3),model:r,choices:[{index:0,delta:{tool_calls:[{index:k,function:{arguments:_.partial_json}}]},logprobs:null,finish_reason:null}]})}}else if(R.type==="message_delta"&&R.delta?.stop_reason&&!i){let _=R.delta.stop_reason;A={id:a||`chatcmpl-${Date.now()}`,object:"chat.completion.chunk",created:Math.floor(Date.now()/1e3),model:r,choices:[{index:0,delta:{},logprobs:null,finish_reason:_==="end_turn"?"stop":_==="max_tokens"?"length":_==="tool_use"?"tool_calls":"stop"}]}}if(A&&!i){let _=`data: ${JSON.stringify(A)}

`;c(s.encode(_))}}catch(R){console.warn("Failed to parse chunk:",R)}}}}i||c(s.encode(`data: [DONE]

`)),h()}catch(m){if(console.error("\u274C Anthropic\u6D41\u8F6C\u6362\u51FA\u9519:",m),!i)try{n.error(m)}catch(p){u("\u26A0\uFE0F \u65E0\u6CD5\u8BBE\u7F6E\u63A7\u5236\u5668\u9519\u8BEF\u72B6\u6001:",p)}}finally{if(d)try{d.releaseLock()}catch(m){u("\u26A0\uFE0F \u91CA\u653Ereader\u9501\u5931\u8D25:",m)}}},cancel(n){u("\u{1F504} Anthropic\u6D41\u88AB\u53D6\u6D88:",n)}})}createOpenAIErrorStream(e){return new ReadableStream({start(t){let n=new TextEncoder,s={id:`chatcmpl-error-${Date.now()}`,object:"chat.completion.chunk",created:Math.floor(Date.now()/1e3),model:"error",choices:[{index:0,delta:{content:`Error: ${e.message}`},logprobs:null,finish_reason:"stop"}]};t.enqueue(n.encode(`data: ${JSON.stringify(s)}

`)),t.enqueue(n.encode(`data: [DONE]

`)),t.close()}})}validateRequest(e){if(!e)throw new Error("Request body is required");if(!e.model)throw new Error("Model is required in request body");if(!e.messages||!Array.isArray(e.messages))throw new Error("Messages array is required in request body");if(e.messages.length===0)throw new Error("At least one message is required")}convertOpenAIToUnified(e){return{messages:e.messages.map(t=>({role:t.role,content:t.content,tool_calls:t.tool_calls,tool_call_id:t.tool_call_id})),model:e.model,max_tokens:e.max_tokens,temperature:e.temperature,stream:e.stream,tools:e.tools?this.convertOpenAIToolsToUnified(e.tools):void 0,tool_choice:e.tool_choice}}convertOpenAIToolsToUnified(e){return e.map(t=>({type:"function",function:{name:t.function.name,description:t.function.description||"",parameters:t.function.parameters}}))}async getAvailableModels(){return{object:"list",data:this.providerService.getAvailableModels().flatMap(t=>t.models.map(n=>({id:n,object:"model",provider:t.provider,created:Math.floor(Date.now()/1e3),owned_by:t.provider})))}}getAvailableModelNames(){return this.providerService.getModelRoutes().map(e=>e.fullModel)}getModelRoutes(){return this.providerService.getModelRoutes()}};var q=class{name="Anthropic";endPoint="/v1/messages";transformRequestOut(e){u("Anthropic Request:",JSON.stringify(e,null,2));let t=[];if(e.system){let r="";typeof e.system=="string"?r=e.system:Array.isArray(e.system)&&(r=e.system.filter(i=>i.type==="text").map(i=>i.text).join(`
`)),r&&t.push({role:"system",content:r})}let n=JSON.parse(JSON.stringify(e.messages||[]));return this.preprocessMessages(n)?.forEach((r,l)=>{if(!r.appended&&(r.role==="user"||r.role==="assistant")){let i={role:r.role,content:null};if(typeof r.content=="string")i.content=r.content,t.push(i);else if(Array.isArray(r.content)){let c=[],h=r.content.filter(p=>p.type==="tool_use"),d=r.content.filter(p=>p.type==="tool_result");r.content.forEach((p,g)=>{p.type==="text"&&p.text&&c.push(p.text)}),c.length>0?i.content=c.join(`
`):u(`message ${l+1} - can not find text content`),h.length>0&&(i.tool_calls=h.map((p,g)=>{let f="{}";try{p.input&&typeof p.input=="object"?f=JSON.stringify(p.input):typeof p.input=="string"&&(JSON.parse(p.input),f=p.input)}catch(x){u("covert tool use error:",x,"origin tool input",p.input),f=JSON.stringify(p.input||{})}return{id:p.id,type:"function",function:{name:p.name,arguments:f}}}));let m=i.content||i.tool_calls&&i.tool_calls.length>0;m&&t.push(i),d.length>0&&d.forEach((p,g)=>{let f={role:"tool",content:typeof p.content=="string"?p.content:JSON.stringify(p.content),tool_call_id:p.tool_use_id};t.push(f)}),!m&&d.length>0}}}),{messages:t,model:e.model,max_tokens:e.max_tokens,temperature:e.temperature,stream:e.stream,tools:e.tools?this.convertAnthropicToolsToUnified(e.tools):void 0,tool_choice:e.tool_choice}}async transformResponseOut(e){if(e.headers.get("Content-Type")?.includes("text/event-stream")){if(!e.body)throw new Error("Stream response body is null");let n=await this.convertOpenAIStreamToAnthropic(e.body);return new Response(n,{headers:{"Content-Type":"text/event-stream","Cache-Control":"no-cache",Connection:"keep-alive"}})}else{let n=await e.json(),s=this.convertOpenAIResponseToAnthropic(n);return new Response(JSON.stringify(s),{headers:{"Content-Type":"application/json"}})}}preprocessMessages(e){let t=[],n=new Map,s=new Map;e.forEach((r,l)=>{Array.isArray(r.content)&&r.content.forEach(i=>{i.type==="tool_result"&&i.tool_use_id&&(n.set(i.tool_use_id,i),s.set(i.tool_use_id,l))})});let a=new Set;for(let r=0;r<e.length;r++){let l=e[r];if(l.role==="assistant"&&Array.isArray(l.content)){let i=l.content.filter(c=>c.type==="tool_use");if(i.length>0){t.push(l);let c=r+1<e.length?e[r+1]:null,h=i.map(p=>p.id),d=!1,m=[];if(c&&Array.isArray(c.content)&&(m=c.content.filter(g=>g.type==="tool_result").map(g=>g.tool_use_id),d=h.every(g=>m.includes(g))),!d){let p=h.filter(f=>!m.includes(f)),g=[];if(p.forEach(f=>{let x=n.get(f);x&&(g.push(x),a.add(f))}),g.length>0){let f={role:"user",content:g,appended:!0};t.push(f)}}}}else if(Array.isArray(l.content)){let i=l.content.filter(c=>c.type==="tool_result"&&c.tool_use_id?!a.has(c.tool_use_id):!0);if(i.length>0){let c={...l,content:i};if(t.push(c),i.length!==l.content.length){let h=l.content.length-i.length}}}else t.push(l)}return t}convertAnthropicToolsToUnified(e){return e.map(t=>({type:"function",function:{name:t.name,description:t.description||"",parameters:t.input_schema}}))}async convertOpenAIStreamToAnthropic(e){return new ReadableStream({async start(n){let s=new TextEncoder,a=`msg_${Date.now()}`,r="unknown",l=!1,i=!1,c=!1,h=new Map,d=new Map,m=0,p=0,g=0,f=!1,x=!1,C={originalChunks:0,processedChunks:0,textDeltas:0,toolCallDeltas:0,errorChunks:0,skippedChunks:0,sentEvents:0},y=_=>{if(!f)try{n.enqueue(_),C.sentEvents++;let k=new TextDecoder().decode(_);u("send data:",k.trim())}catch(k){if(k instanceof TypeError&&k.message.includes("Controller is already closed"))f=!0;else throw u(`send data error: ${k.message}`),k}},R=()=>{if(!f)try{n.close(),f=!0}catch(_){if(_ instanceof TypeError&&_.message.includes("Controller is already closed"))f=!0;else throw _}},A=null;try{A=e.getReader();let _=new TextDecoder,k="";for(;!f;){let{done:j,value:ce}=await A.read();if(j)break;k+=_.decode(ce,{stream:!0});let X=k.split(`
`);k=X.pop()||"";for(let Y of X){if(f||c)break;if(Y.startsWith("data: ")){let Z=Y.slice(6);if(Z==="[DONE]")continue;try{let I=JSON.parse(Z);if(C.originalChunks++,m++,u("Original OpenAI data:",JSON.stringify(I,null,2)),r=I.model||r,!l&&!f&&!c){l=!0;let v={type:"message_start",message:{id:a,type:"message",role:"assistant",content:[],model:r,stop_reason:null,stop_sequence:null}};u("send message_start event:",JSON.stringify(v,null,2)),y(s.encode(`event: message_start
data: ${JSON.stringify(v)}

`))}let T=I.choices?.[0];if(!T){C.skippedChunks++;continue}if(u("Choice Data:",JSON.stringify(T,null,2)),C.processedChunks++,T?.delta?.thinking&&!f&&!c){if(!x){let v={type:"content_block_start",index:0,content_block:{type:"thinking",thinking:""}};y(s.encode(`event: content_block_start
data: ${JSON.stringify(v)}

`)),x=!0}if(T.delta.thinking.signature){let v={type:"content_block_delta",index:0,delta:{type:"signature_delta",signature:T.delta.thinking.signature}};y(s.encode(`event: content_block_delta
data: ${JSON.stringify(v)}

`));let S={type:"content_block_stop",index:0};y(s.encode(`event: content_block_stop
data: ${JSON.stringify(S)}

`))}else if(T.delta.thinking.content){let v={type:"content_block_delta",index:0,delta:{type:"thinking_delta",thinking:T.delta.thinking.content||""}};y(s.encode(`event: content_block_delta
data: ${JSON.stringify(v)}

`))}}if(T?.delta?.content&&!f&&!c){if(p++,C.textDeltas++,!i&&!c){i=!0;let v={type:"content_block_start",index:0,content_block:{type:"text",text:""}};u("send content_block_start data:",JSON.stringify(v,null,2)),y(s.encode(`event: content_block_start
data: ${JSON.stringify(v)}

`))}if(!f&&!c){let v={type:"content_block_delta",index:0,delta:{type:"text_delta",text:T.delta.content}};u("compare data:"),u(`   OpenAI:    choice.delta.content = "${T.delta.content}"`),u(`   Anthropic: delta.text = "${v.delta.text}"`),y(s.encode(`event: content_block_delta
data: ${JSON.stringify(v)}

`))}}if(T?.delta?.tool_calls&&!f&&!c){g++,C.toolCallDeltas++;let v=new Set;for(let S of T.delta.tool_calls){if(f)break;let w=S.index??0;if(v.has(w))continue;if(v.add(w),!d.has(w)){let b=i?d.size+1:d.size;if(b!==0){let H={type:"content_block_stop",index:b-1};y(s.encode(`event: content_block_stop
data: ${JSON.stringify(H)}

`))}d.set(w,b);let M=S.id||`call_${Date.now()}_${w}`,U=S.function?.name||`tool_${w}`,O={type:"content_block_start",index:b,content_block:{type:"tool_use",id:M,name:U,input:{}}};y(s.encode(`event: content_block_start
data: ${JSON.stringify(O)}

`));let E={id:M,name:U,arguments:"",contentBlockIndex:b};h.set(w,E)}else if(S.id&&S.function?.name){let b=h.get(w);b.id.startsWith("call_")&&b.name.startsWith("tool_")&&(b.id=S.id,b.name=S.function.name)}if(S.function?.arguments&&!f&&!c){let b=d.get(w);if(b===void 0)continue;let M=h.get(w);if(M){let U=M.arguments;M.arguments+=S.function.arguments;try{let O=null,E=M.arguments.trim();if(E.startsWith("{")&&E.endsWith("}"))try{O=JSON.parse(E)}catch(H){u("Tool call index:",w,"error",H.message)}}catch(O){u("Tool call index:",w,"error",O.message)}}try{let U={type:"content_block_delta",index:b,delta:{type:"input_json_delta",partial_json:S.function.arguments}};y(s.encode(`event: content_block_delta
data: ${JSON.stringify(U)}

`))}catch{try{let O=S.function.arguments.replace(/[\x00-\x1F\x7F-\x9F]/g,"").replace(/\\/g,"\\\\").replace(/"/g,'\\"'),E={type:"content_block_delta",index:b,delta:{type:"input_json_delta",partial_json:O}};y(s.encode(`event: content_block_delta
data: ${JSON.stringify(E)}

`))}catch(O){console.error(O)}}}}}if(T?.finish_reason&&!f&&!c){if(c=!0,p===0&&g===0&&console.error("Warning: No content in the stream response!"),i&&!f){let v={type:"content_block_stop",index:0};y(s.encode(`event: content_block_stop
data: ${JSON.stringify(v)}

`))}if(g>0&&!f){for(let[S,w]of d.entries()){if(f)break;let J=h.get(S);if(J&&J.arguments)try{let b=J.arguments.trim();b.startsWith("{")||(b="{"+b),b.endsWith("}")||(b=b+"}"),JSON.parse(b)}catch(b){u("Tool call final arguments parsing failed:",b.message,"original arguments:",J.arguments)}}let v={type:"content_block_stop",index:d.size-1};y(s.encode(`event: content_block_stop
data: ${JSON.stringify(v)}

`))}if(!f){let w={type:"message_delta",delta:{stop_reason:{stop:"end_turn",length:"max_tokens",tool_calls:"tool_use",content_filter:"stop_sequence"}[T.finish_reason]||"end_turn",stop_sequence:null},usage:{input_tokens:I.usage?.prompt_tokens||0,output_tokens:I.usage?.completion_tokens||0}};y(s.encode(`event: message_delta
data: ${JSON.stringify(w)}

`))}if(!f){let v={type:"message_stop"};y(s.encode(`event: message_stop
data: ${JSON.stringify(v)}

`))}break}}catch{C.errorChunks++}}}}R()}catch(_){if(!f)try{n.error(_)}catch(k){console.error(k)}}finally{if(A)try{A.releaseLock()}catch(_){console.error(_)}}},cancel(n){u("cancle stream:",n)}})}convertOpenAIResponseToAnthropic(e){u("Original OpenAI response:",JSON.stringify(e,null,2));let t=e.choices[0];if(!t)throw new Error("No choices found in OpenAI response");let n=[];t.message.content&&n.push({type:"text",text:t.message.content}),t.message.tool_calls&&t.message.tool_calls.length>0&&t.message.tool_calls.forEach((a,r)=>{let l={};try{let i=a.function.arguments||"{}";typeof i=="object"?l=i:typeof i=="string"&&(l=JSON.parse(i))}catch{l={text:a.function.arguments||""}}n.push({type:"tool_use",id:a.id,name:a.function.name,input:l})});let s={id:e.id,type:"message",role:"assistant",model:e.model,content:n,stop_reason:t.finish_reason==="stop"?"end_turn":t.finish_reason==="length"?"max_tokens":t.finish_reason==="tool_calls"?"tool_use":t.finish_reason==="content_filter"?"stop_sequence":"end_turn",stop_sequence:null,usage:{input_tokens:e.usage?.prompt_tokens||0,output_tokens:e.usage?.completion_tokens||0}};return u("Conversion complete, final Anthropic response:",JSON.stringify(s,null,2)),s}};var W=class{name="Gemini";endPoint="/v1beta/models/:model";transformRequestOut(e){return Array.isArray(e.tools)&&e.tools.forEach(t=>{if(t.function.name==="BatchTool"){t.function.parameters.properties.invocations.items.properties.input.type="number";return}Object.keys(t.function.parameters.properties).forEach(n=>{let s=t.function.parameters.properties[n];s.type==="string"&&!["enum","date-time"].includes(s.format)&&delete s.format})}),e}async transformResponseOut(e){return e}};var V=class{name="deepseek";transformRequestOut(e){return e.max_tokens&&e.max_tokens>8192&&(e.max_tokens=8192),e}async transformResponseOut(e){if(e.headers.get("Content-Type")?.includes("application/json")){let t=await e.json();return new Response(JSON.stringify(t),{status:e.status,statusText:e.statusText,headers:e.headers})}else if(e.headers.get("Content-Type")?.includes("stream")){if(!e.body)return e;let t=new TextDecoder,n=new TextEncoder,s="",a=!1,r=new ReadableStream({async start(l){let i=e.body.getReader();try{for(;;){let{done:c,value:h}=await i.read();if(c)break;let m=t.decode(h,{stream:!0}).split(`
`);for(let p of m)if(p.startsWith("data: ")&&p.trim()!=="data: [DONE]")try{let g=JSON.parse(p.slice(6));if(g.choices?.[0]?.delta?.reasoning_content){s+=g.choices[0].delta.reasoning_content;let f={...g,choices:[{...g.choices[0],delta:{...g.choices[0].delta,thinking:{content:g.choices[0].delta.reasoning_content}}}]},x=`data: ${JSON.stringify(f)}

`;l.enqueue(n.encode(x))}if(g.choices?.[0]?.delta?.content&&!g.choices[0].delta.reasoning_content&&s&&!a){a=!0;let f=Date.now().toString(),x={...g,choices:[{...g.choices[0],delta:{...g.choices[0].delta,thinking:{content:s,signature:f}}}]};console.log("Thinking chunk created:",x);let C=`data: ${JSON.stringify(x)}

`;l.enqueue(n.encode(C))}if(g.choices?.[0]?.delta?.reasoning_content&&delete g.choices[0].delta.reasoning_content,g.choices?.[0]?.delta&&Object.keys(g.choices[0].delta).length>0){let f=`data: ${JSON.stringify(g)}

`;l.enqueue(n.encode(f))}}catch{l.enqueue(n.encode(p+`
`))}else l.enqueue(n.encode(p+`
`))}}catch(c){l.error(c)}finally{try{i.releaseLock()}catch{}l.close()}}});return new Response(r,{status:e.status,statusText:e.statusText,headers:{"Content-Type":e.headers.get("Content-Type")||"text/plain","Cache-Control":"no-cache",Connection:"keep-alive"}})}return e}};var z=class{transformers=new Map;constructor(){this.initialize()}registerTransformer(e,t){this.transformers.set(e,t),u(`register transformer: ${e}${t.endPoint?` (endpoint: ${t.endPoint})`:" (\u65E0endpoint)"}`)}getTransformer(e){return this.transformers.get(e)}getAllTransformers(){return new Map(this.transformers)}getTransformersWithEndpoint(){let e=[];return this.transformers.forEach((t,n)=>{t.endPoint&&e.push({name:n,transformer:t})}),e}getTransformersWithoutEndpoint(){let e=[];return this.transformers.forEach((t,n)=>{t.endPoint||e.push({name:n,transformer:t})}),e}removeTransformer(e){return this.transformers.delete(e)}hasTransformer(e){return this.transformers.has(e)}async registerTransformerFromConfig(e){try{if(e.path){let t=require(e.path);if(t){let n=new t(e.options);if(!n.name)throw new Error(`Transformer instance from ${e.path} does not have a name property.`);return this.registerTransformer(n.name,n),!0}}return!1}catch(t){return u(`load transformer (${e.path}):`,t),!1}}async initialize(){try{await this.registerDefaultTransformersInternal(),await this.loadFromConfig()}catch(e){u("TransformerService init error:",e)}}async registerDefaultTransformersInternal(){try{let e=new q,t=new W,n=new V;this.registerTransformer(e.name,e),this.registerTransformer(t.name,t),this.registerTransformer(n.name,n)}catch(e){u("transformer regist error:",e)}}async loadFromConfig(){let e=P.get("transformers",[]);for(let t of e)await this.registerTransformerFromConfig(t)}};var ie=async o=>{let e=new D,t=new N,n=new z;o.get("/",async(a,r)=>({message:"LLMs API",version:"1.0.0"})),o.get("/health",async(a,r)=>({status:"ok",timestamp:new Date().toISOString()})),o.post("/v1/chat/completions",{schema:{body:{type:"object",properties:{messages:{type:"array"},model:{type:"string"},max_tokens:{type:"number"},temperature:{type:"number"},stream:{type:"boolean"}},required:["messages","model"]}}},async(a,r)=>{let l=await e.handleOpenAIFormatRequest({...a.body,model:"deepseek,deepseek-chat",max_tokens:8192});return a.body?.stream===!0?(r.header("Content-Type","text/event-stream"),r.header("Cache-Control","no-cache"),r.header("Connection","keep-alive"),r.send(l.body)):l.json()});let s=n.getTransformersWithEndpoint();for(let{name:a,transformer:r}of s)r.endPoint&&o.post(r.endPoint,async(l,i)=>{let c=l.body,h=l.provider,d=t.getProvider(h);if(!d)throw $(`Provider '${h}' not found`,404,"provider_not_found");let m=typeof r.transformRequestOut=="function"?r.transformRequestOut(c):c;if(d.transformer?.use?.length)for(let C of d.transformer.use){let y=n.getTransformer(C);!y||typeof y.transformRequestOut!="function"||(m=y.transformRequestOut(m))}if(d.transformers?.[l.body.model]?.use?.length)for(let C of d.transformers[l.body.model].use){let y=n.getTransformer(C);!y||typeof y.transformRequestOut!="function"||(m=y.transformRequestOut(m))}let p=new URL("/v1/chat/completions",d.baseUrl.endsWith("/")?d.baseUrl:`${d.baseUrl}/`),f=await L(p,m,{headers:{Authorization:`Bearer ${d.apiKey}`}});if(d.transformer?.use?.length)for(let C of d.transformer.use){let y=n.getTransformer(C);!y||typeof y.transformResponseOut!="function"||(f=await y.transformResponseOut(f))}if(d.transformers?.[l.body.model]?.use?.length)for(let C of d.transformers[l.body.model].use){let y=n.getTransformer(C);!y||typeof y.transformResponseOut!="function"||(f=await y.transformResponseOut(f))}return r.transformResponseOut&&(f=await r.transformResponseOut(f)),f.ok||i.code(f.status),c?.stream===!0?(i.header("Content-Type","text/event-stream"),i.header("Cache-Control","no-cache"),i.header("Connection","keep-alive"),i.send(f.body)):f.json()});o.post("/providers",{schema:{body:{type:"object",properties:{id:{type:"string"},name:{type:"string"},type:{type:"string",enum:["openai","anthropic"]},baseUrl:{type:"string"},apiKey:{type:"string"},models:{type:"array",items:{type:"string"}}},required:["id","name","type","baseUrl","apiKey","models"]}}},async(a,r)=>{let{name:l,type:i,baseUrl:c,apiKey:h,models:d}=a.body;if(!l?.trim())throw $("Provider name is required",400,"invalid_request");if(!c||!we(c))throw $("Valid base URL is required",400,"invalid_request");if(!h?.trim())throw $("API key is required",400,"invalid_request");if(!d||!Array.isArray(d)||d.length===0)throw $("At least one model is required",400,"invalid_request");if(t.getProvider(id))throw $(`Provider with ID '${id}' already exists`,400,"provider_exists");return t.registerProvider(a.body)}),o.get("/providers",async(a,r)=>t.getProviders()),o.get("/providers/:id",{schema:{params:{type:"object",properties:{id:{type:"string"}},required:["id"]}}},async(a,r)=>{let l=t.getProvider(a.params.id);return l||r.code(404).send({error:"Provider not found"})}),o.put("/providers/:id",{schema:{params:{type:"object",properties:{id:{type:"string"}},required:["id"]},body:{type:"object",properties:{name:{type:"string"},type:{type:"string",enum:["openai","anthropic"]},baseUrl:{type:"string"},apiKey:{type:"string"},models:{type:"array",items:{type:"string"}},enabled:{type:"boolean"}}}}},async(a,r)=>{let l=t.updateProvider(a.params.id,a.body);return l||r.code(404).send({error:"Provider not found"})}),o.delete("/providers/:id",{schema:{params:{type:"object",properties:{id:{type:"string"}},required:["id"]}}},async(a,r)=>t.deleteProvider(a.params.id)?{message:"Provider deleted successfully"}:r.code(404).send({error:"Provider not found"})),o.patch("/providers/:id/toggle",{schema:{params:{type:"object",properties:{id:{type:"string"}},required:["id"]},body:{type:"object",properties:{enabled:{type:"boolean"}},required:["enabled"]}}},async(a,r)=>t.toggleProvider(a.params.id,a.body.enabled)?{message:`Provider ${a.body.enabled?"enabled":"disabled"} successfully`}:r.code(404).send({error:"Provider not found"}))};function we(o){try{return new URL(o),!0}catch{return!1}}async function Te(){let o=(0,ae.default)({logger:P.get("NODE_ENV")!=="test"});return o.setErrorHandler(oe),await o.register(le.default),o.addHook("preHandler",async(e,t)=>{try{if(!e.body||!e.body.model)return t.code(400).send({error:"Missing model in request body"});let[n,s]=e.body.model.split(",");e.body.model=s,e.provider=n;return}catch(n){return e.log.error("Error in modelProviderMiddleware:",n),t.code(500).send({error:"Internal server error"})}}),await o.register(ie),o}var Q=class{config;constructor(){this.config={port:parseInt(P.get("PORT")||"3000",10),host:P.get("HOST")||"0.0.0.0",logger:P.get("NODE_ENV")!=="test"}}async start(){try{let e=await Te(),t=await e.listen({port:this.config.port,host:this.config.host});u(`\u{1F680} LLM Smart Router API server listening on ${t}`);let n=async s=>{u(`Received ${s}, shutting down gracefully...`),await e.close(),process.exit(0)};process.on("SIGINT",()=>n("SIGINT")),process.on("SIGTERM",()=>n("SIGTERM"))}catch(e){u(`Error starting server: ${e}`),process.exit(1)}}};async function Ae(){u("\u{1F527} Configuration loaded:"),u(P.getConfigSummary()),await new Q().start()}process.on("unhandledRejection",(o,e)=>{u(`Unhandled Rejection at: ${e}, reason: ${o}`),process.exit(1)});process.on("uncaughtException",o=>{u(`Uncaught Exception: ${o}`),process.exit(1)});require.main===module&&Ae().catch(console.error);
//# sourceMappingURL=server.js.map
